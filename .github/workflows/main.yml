name: Build OpenAWE
on: ['push', 'pull_request']

env:
  BUILD_TYPE: Release
  VCPKG_DEFAULT_TRIPLET: x64-windows

jobs:
  build:
    strategy:
      matrix:
        include:
          - name: Linux GCC
            os: ubuntu-20.04
            extra_cmake_args: -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
          - name: Linux Clang
            os: ubuntu-20.04
            extra_cmake_args: -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          - name: Windows MSVC
            os: windows-2019
            extra_cmake_args: -DCMAKE_TOOLCHAIN_FILE=$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake
          - name: MacOS Clang
            os: macos-11
            extra_cmake_args: -DOPENAL_LIBRARY=/usr/local/opt/openal-soft/lib/libopenal.dylib -DOPENAL_INCLUDE_DIR=/usr/local/opt/openal-soft/include/AL

    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'true'

      - name: Install dependencies with APT
        if: ${{ matrix.os == 'ubuntu-20.04' }}
        run: |
          sudo apt-get update
          sudo apt-get -y install \
            libtinyxml2-dev \
            zlib1g-dev \
            libgl-dev \
            libglfw3-dev \
            libopenal-dev \
            libglm-dev \
            libbullet-dev \
            libfmt-dev \
            libogg-dev \
            libtheora-dev \
            libvorbis-dev \
            libspdlog-dev \
            libglew-dev \
            libgtest-dev

      - name: Cache dependencies for vcpkg
        if: ${{ matrix.os == 'windows-2019' }}
        uses: actions/cache@v3
        with:
          path: $VCPKG_DEFAULT_BINARY_CACHE
          key: ${{matrix.os}}-build-vcpkg-cache-${{ github.ref_name }}
          restore-keys: |
            ${{matrix.os}}-build-vcpkg-cache-master
            ${{matrix.os}}-build-vcpkg-cache-

      - name: Install dependencies with vcpkg
        if: ${{ matrix.os == 'windows-2019' }}
        run: |
          vcpkg update
          vcpkg install zlib glfw3 libogg libvorbis libtheora spdlog glew openal-soft bullet3 fmt gtest tinyxml2 glm opengl

      - name: Install dependencies with brew
        if: ${{ matrix.os == 'macos-11' }}
        run: |
          brew update
          brew install zlib glfw libogg libvorbis theora spdlog glew openal-soft bullet fmt googletest tinyxml2 glm

      - name: Configure CMake
        shell: bash
        run: |
          cmake -B $GITHUB_WORKSPACE/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} ${{ matrix.extra_cmake_args }} .

      - name: Build
        shell: bash
        run: cmake --build $GITHUB_WORKSPACE/build --config ${{env.BUILD_TYPE}}

      - name: Test
        working-directory: ${{github.workspace}}/build
        shell: bash
        run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure

      - name: Pack Artifacts
        working-directory: ${{github.workspace}}/build
        shell: bash
        run: cpack

      - name: Publish Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.name }}
          path: ${{github.workspace}}/build/*.zip
